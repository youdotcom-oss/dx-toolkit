name: "Package: publish @youdotcom-oss/mcp"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "New version tag (e.g., 1.0.0)"
        required: true
      next:
        description: "Next prerelease number (optional)"
        required: false

permissions:
  contents: write
  id-token: write
  issues: write

jobs:
  publish:
    uses: ./.github/workflows/_publish-package.yml
    secrets:
      PUBLISH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
    with:
      npm_package_name: "@youdotcom-oss/mcp"
      version: ${{ github.event.inputs.version }}
      next: ${{ github.event.inputs.next }}

  update-remote-version:
    needs: [publish]
    runs-on: ubuntu-latest
    steps:
      - name: Trigger version update via repository_dispatch
        env:
          GH_TOKEN: ${{ secrets.RELEASE_ADMIN_TOKEN }}
        run: |
          gh api repos/${{ secrets.DEPLOYMENT_REPO }}/dispatches \
            --method POST \
            --field event_type="update-mcp-version" \
            --field client_payload[version]="${{ needs.publish.outputs.version }}"

  deploy-production:
    if: needs.publish.outputs.is_prerelease == 'false'
    needs: [publish, update-remote-version]
    runs-on: ubuntu-latest
    steps:
      - name: Wait for remote version update to complete
        env:
          GH_TOKEN: ${{ secrets.RELEASE_ADMIN_TOKEN }}
          VERSION: ${{ needs.publish.outputs.version }}
        run: |
          echo "â³ Waiting for version update to complete on ${{ secrets.DEPLOYMENT_REPO }}..."
          echo "Looking for release: v${VERSION}"

          max_attempts=3  # Check up to 3 times (20s, 40s, 60s)
          check_interval=20  # Check every 20 seconds
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Waiting ${check_interval}s before check ${attempt}/${max_attempts}..."
            sleep $check_interval

            # Check if the release exists (uses Contents: read permission)
            if gh api "repos/${{ secrets.DEPLOYMENT_REPO }}/releases/tags/v${VERSION}" >/dev/null 2>&1; then
              echo "âœ… Version update completed - release v${VERSION} found on remote"
              exit 0
            else
              echo "Release not found yet, continuing..."
            fi
          done

          echo "âš ï¸ Version update did not complete after ${max_attempts} checks ($((max_attempts * check_interval))s total)"
          echo "Release v${VERSION} was not found on ${{ secrets.DEPLOYMENT_REPO }}"
          exit 1

      - name: Trigger production deployment via repository_dispatch
        env:
          GH_TOKEN: ${{ secrets.RELEASE_ADMIN_TOKEN }}
        run: |
          gh api repos/${{ secrets.DEPLOYMENT_REPO }}/dispatches \
            --method POST \
            --field event_type="deploy-mcp-production" \
            --field client_payload[version]="${{ needs.publish.outputs.version }}"

  publish-to-official-registry:
    if: needs.publish.outputs.is_prerelease == 'false'
    needs: [publish, deploy-production]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}

      - name: Update server.json versions
        env:
          VERSION: ${{ needs.publish.outputs.version }}
        run: |
          cd packages/mcp
          # Update both the top-level version and the packages[0].version
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > server.tmp && mv server.tmp server.json
          echo "âœ… Updated server.json versions to $VERSION"
          echo "Top-level version: $(jq -r '.version' server.json)"
          echo "Package version: $(jq -r '.packages[0].version' server.json)"

      - name: Install mcp-publisher
        run: |
          curl -L "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_$(uname -s | tr '[:upper:]' '[:lower:]')_$(uname -m | sed 's/x86_64/amd64/;s/aarch64/arm64/').tar.gz" | tar xz mcp-publisher
          sudo mv mcp-publisher /usr/local/bin/

      - name: Authenticate with MCP Registry
        run: |
          cd packages/mcp
          mcp-publisher login github-oidc

      - name: Publish to MCP Registry
        run: |
          cd packages/mcp
          mcp-publisher publish

      - name: Commit and push server.json version update
        env:
          VERSION: ${{ needs.publish.outputs.version }}
          GH_TOKEN: ${{ secrets.PUBLISH_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/mcp/server.json
          git commit -m "chore(mcp): update server.json to version ${VERSION} [skip ci]

          Automated version sync for Anthropic MCP Registry publishing.

          ðŸ¤– Generated by GitHub Actions"
          git push "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" HEAD:main
